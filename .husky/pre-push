#!/bin/bash

# Load Jenkins config from .env.local (not in git)
ENV_FILE="$(dirname "$0")/../.env.local"
if [ -f "$ENV_FILE" ]; then
    export $(grep -E '^JENKINS_' "$ENV_FILE" | xargs)
fi

# Validate required variables
if [ -z "$JENKINS_USER" ] || [ -z "$JENKINS_API_TOKEN" ] || [ -z "$JENKINS_JOB_TOKEN" ] || [ -z "$JENKINS_URL" ]; then
    echo "Warning: Jenkins config not found in .env.local, skipping build trigger"
    exit 0
fi

while read local_ref local_sha remote_ref remote_sha; do
    if [[ "$remote_ref" == "refs/heads/Development" ]]; then
        echo "Jenkins build will be triggered in 10 seconds..."
        # Run in background with delay so push completes first
        # nohup ensures it survives after the hook exits
        nohup bash -c "sleep 10 && curl -k -s -u '${JENKINS_USER}:${JENKINS_API_TOKEN}' -X POST '${JENKINS_URL}?token=${JENKINS_JOB_TOKEN}&Branch=Development&cause=Git+push+to+Development'" > /dev/null 2>&1 &
    fi
done

exit 0
