
<q-form @@submit="submitEpa()" v-if="showForm" class="q-mb-md">
    <div class="row">
        <q-input outlined dense type="numeric" label="Order" step="1" v-model="epa.order" class="col-4 col-md-3 col-lg-1"></q-input>
    </div>
    <div class="row">
        <q-input outlined dense type="text" label="Name" v-model="epa.name" class="col col-lg-6"></q-input>
    </div>
    <div class="row">
        <q-editor v-model="epa.description" min-height="15rem" class="col col-lg-8"
                  :toolbar="[
                    [ 'left', 'center', 'right', 'justify' ],
                    [ 'bold', 'italic', 'underline', 'strike' ],
                    ['quote', 'unordered', 'ordered', 'outdent', 'indent'],
                    [ 'undo', 'redo' ],
                    ['viewsource'] ]"></q-editor>
        @*<q-input outlined dense type="textarea" label="Description" v-model="epa.description" class="col col-lg-6"></q-input>*@
    </div>
    <div class="row">
        <q-toggle label="Active" v-model="epa.active"></q-toggle>
    </div>
    <div class="row">
        <q-btn dense no-caps type="submit" :label="(epa?.epaId ? 'Update' : 'Create') + ' EPA'" color="primary"
               class="q-mt-sm col col-4 col-md-4 col-lg-1"></q-btn>
        <q-btn dense no-caps type="button" label="Clear" color="secondary" @@click="clearEpa()"
               v-if="epa?.epaId"
               class="q-mt-sm q-ml-lg col col-4 col-md-4 col-lg-1"></q-btn>
        <q-btn dense no-caps type="button" label="Delete EPA" color="red" @@click="deleteEpa()"
               v-if="epa?.epaId"
               class="q-mt-sm q-ml-lg col col-4 col-md-4 col-lg-1"></q-btn>
    </div>
    <hr />
</q-form>

<h3>
    <q-btn no-caps size="md" label="Add EPA" color="green" @@click="this.showForm=true"></q-btn>
</h3>

<q-list separator>
    <q-item-label header class="text-h6 text-dark">
        Entrustable Professional Activities
    </q-item-label>
    <q-item>
        <q-item-section top side class="text-dark col-1">Edit</q-item-section>
        <q-item-section top side class="text-dark col-1">Active</q-item-section>
        <q-item-section top side class="text-dark col-1">Order</q-item-section>
        <q-item-section top side class="text-dark col-4">Name</q-item-section>
        <q-item-section top class="text-dark col-5">Description</q-item-section>
    </q-item>
    <q-item v-for="epa in epas">
        <q-item-section top side class="text-dark col-1">
            <q-btn dense no-caps size="md" icon="edit" color="primary" @@click="selectEpa(epa)"></q-btn>
        </q-item-section>
        <q-item-section top side class="text-dark col-1">
            <q-icon :name="epa.active ? 'check' : 'close'" :color="epa.active ? 'green' : 'red'"></q-icon>
        </q-item-section>
        <q-item-section top side class="text-dark col-1">
            {{epa.order}}
        </q-item-section>
        <q-item-section top side class="text-dark col-4">
            {{epa.name}}
        </q-item-section>
        @*v-html - this is sanitized in EpaController*@
        <q-item-section top class="text-dark col-5" v-html="epa.description"></q-item-section>
    </q-item>
</q-list>

@section Scripts {
    <script asp-add-nonce="true">
        createVueApp({
            data() {
                return {
                    epas: [],
                    epa: {},
                    showForm: false
                }
            },
            methods: {
                getEpas: async function () {
                    viperFetch(this, "epas")
                        .then(data => this.epas = data)
                    this.clearEpa()
                },
                selectEpa: function (epa) {
                    this.epa = epa
                    this.showForm = true
                },
                submitEpa: async function () {
                    var u = this.epa?.epaId ? ("epas/" + this.epa.epaId) : "epas"
                    await viperFetch(this, u, {
                        method: this.epa?.epaId ? "PUT" : "POST",
                        body: JSON.stringify(this.epa),
                        headers: { "Content-Type": "application/json" }
                    })
                    this.getEpas()
                },
                deleteEpa: async function () {
                    await viperFetch(this, "epas/" + this.epa.epaId, { method: "DELETE", headers: { "Content-Type": "application/json" } })
                    this.getEpas()
                },
                clearEpa: async function () {
                    this.epa = { active: true, description: "" }
                    this.showForm = false
                }
            },
            mounted: async function () {
                await this.getEpas()
            }
        })
    </script>
}